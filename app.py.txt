# Streamlit рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЗржирж╕рзНржЯрж▓ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
!pip install streamlit

import streamlit as st
import pandas as pd
import gspread
import time # Streamlit-ржП ржбрзЗржЯрж╛ рж░рж┐ржлрзНрж░рзЗрж╢ ржХрж░рж╛рж░ ржЬржирзНржп

# --- ржЖржкржирж╛рж░ рж╕рзЗржЯрж┐ржВрж╕ ржЖржмрж╛рж░ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи ---
SERVICE_ACCOUNT_FILE = 'ржЖржкржирж╛рж░_ржбрж╛ржЙржирж▓рзЛржб_ржХрж░рж╛_ржлрж╛ржЗрж▓ржЯрж┐рж░_ржЖрж╕рж▓_ржирж╛ржо.json' # ржЖржкржирж╛рж░ JSON ржлрж╛ржЗрж▓рзЗрж░ рж╕ржарж┐ржХ ржирж╛ржо
SHEET_NAME = "ржЖржкржирж╛рж░ Google Sheet-ржПрж░ ржЖрж╕рж▓ ржирж╛ржоржЯрж┐ ржжрж┐ржи"       # ржЖржкржирж╛рж░ Google Sheet-ржПрж░ рж╕ржарж┐ржХ ржирж╛ржо
WORKSHEET_NAME = "Meter_Master_Data"                          # ржЖржкржирж╛рж░ ржбрзЗржЯрж╛ ржЯрзНржпрж╛ржмрзЗрж░ ржирж╛ржо

# ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ рж╣рж┐рж╕рзЗржмрзЗ Google Sheets ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЗржирж┐рж╢рж┐ржпрж╝рж╛рж▓рж╛ржЗржЬ ржХрж░рж╛
try:
    gc = gspread.service_account(filename=SERVICE_ACCOUNT_FILE)
except Exception as e:
    st.error(f"тЭМ ржХрж╛ржирзЗржХрж╢ржи ржПрж░рж░: рж╕рж╛рж░рзНржнрж┐рж╕ ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯ ржХрзА ржлрж╛ржЗрж▓ рж▓рзЛржб ржХрж░рж╛ ржпрж╛ржпрж╝ржирж┐ред {e}")
    st.stop()


# @st.cache_data ржбрзЗржХрзЛрж░рзЗржЯрж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржбрзЗржЯрж╛ ржжрзНрж░рзБржд рж▓рзЛржб ржХрж░рж╛
# ржПржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ Google Sheets ржерзЗржХрзЗ ржмрж╛рж░ржмрж╛рж░ ржбрзЗржЯрж╛ рж▓рзЛржб ржирж╛ рж╣ржпрж╝ ржПржмржВ ржПржЯрж┐ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ рж░рж┐ржлрзНрж░рзЗрж╢ рж╣ржпрж╝ (ржкрзНрж░рждрж┐ 300 рж╕рзЗржХрзЗржирзНржбрзЗ ржмрж╛ 5 ржорж┐ржирж┐ржЯрзЗ)
@st.cache_data(ttl=300) 
def load_data_from_sheet():
    """Google Sheet ржерзЗржХрзЗ рж╕ржорж╕рзНржд ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рзЗред"""
    try:
        sh = gc.open(SHEET_NAME)
        worksheet = sh.worksheet(WORKSHEET_NAME)
        
        # рж╕ржорж╕рзНржд ржбрзЗржЯрж╛ pandas DataFrame-ржП рж▓рзЛржб ржХрж░рж╛
        data = worksheet.get_all_records()
        df = pd.DataFrame(data)
        
        # ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрж▓рж╛ржоржЧрзБрж▓рж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи (ржкрзНрж░ржержо ржЕржХрзНрж╖рж░ ржмржбрж╝ рж╣рж╛рждрзЗрж░, ржпрзЗржоржи 'Meter Number')
        # ржпржжрж┐ ржЖржкржирж╛рж░ ржХрж▓рж╛ржорзЗрж░ ржирж╛ржоржЧрзБрж▓рж┐ ржнрж┐ржирзНржи рж╣ржпрж╝, рждржмрзЗ ржПржЦрж╛ржирзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи:
        df.columns = [col.strip() for col in df.columns] 
        
        return df
    
    except gspread.exceptions.SpreadsheetNotFound:
        st.error(f"тЭМ ржбрзЗржЯрж╛ржмрзЗрж╕ ржПрж░рж░: рж╢рзАржЯ '{SHEET_NAME}' ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред")
        return pd.DataFrame()
    except Exception as e:
        st.error(f"тЭМ ржбрзЗржЯрж╛ рж▓рзЛржбрж┐ржВ ржПрж░рж░: {e}")
        return pd.DataFrame()

# Streamlit ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржорзВрж▓ ржХрж╛ржарж╛ржорзЛ
def main_app():
    st.title("ЁЯТб ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржорж┐ржЯрж╛рж░ ржЯрзНрж░рзНржпрж╛ржХрж┐ржВ ржкрзЛрж░рзНржЯрж╛рж▓")
    st.markdown("---")

    # ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
    df_master = load_data_from_sheet()

    if df_master.empty:
        st.info("тЪая╕П ржбрзЗржЯрж╛ржмрзЗрж╕рзЗ ржХрзЛржирзЛ ржбрзЗржЯрж╛ ржирзЗржЗ ржмрж╛ рж▓рзЛржбрж┐ржВ-ржП рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред")
        return

    # ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯрзЗрж░ ржирж╛ржо ржЗржиржкрзБржЯ ржирзЗржУржпрж╝рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржЯрзЗржХрзНрж╕ржЯ ржмржХрзНрж╕ рждрзИрж░рж┐ ржХрж░рж╛
    client_input = st.text_input(
        "ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржкржирж╛рж░ **ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯрзЗрж░ ржкрзБрж░рзЛ ржирж╛ржо** ржПржЦрж╛ржирзЗ рж▓рж┐ржЦрзБржи:",
        placeholder="ржпрзЗржоржи: Client A ржмрж╛ Ramesh Mondal"
    )

    if client_input:
        # ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯрзЗрж░ ржирж╛ржо ржЕржирзБржпрж╛ржпрж╝рзА ржбрзЗржЯрж╛ ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░рж╛
        # 'Client Name' ржХрж▓рж╛ржоржЯрж┐ ржЖржкржирж╛рж░ рж╢рзАржЯрзЗрж░ ржХрж▓рж╛ржорзЗрж░ ржирж╛ржорзЗрж░ рж╕рж╛ржерзЗ рж╣рзБржмрж╣рзБ ржорж┐рж▓рждрзЗ рж╣ржмрзЗ
        # .str.lower() ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ ржпрж╛рждрзЗ ржХрзЗрж╕ рж╕рзЗржирзНрж╕рж┐ржЯрж┐ржнрж┐ржЯрж┐ (ржмржбрж╝/ржЫрзЛржЯ ржЕржХрзНрж╖рж░) рж╕ржорж╕рзНржпрж╛ ржирж╛ ржХрж░рзЗ
        filtered_df = df_master[df_master['Client Name'].str.lower() == client_input.lower()]
        
        # рж╢рзБржзрзБржорж╛рждрзНрж░ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯржжрзЗрж░ ржжрзЗржЦрж╛ржирзЛрж░ ржЬржирзНржп ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржХрж▓рж╛ржоржЧрзБрж▓рж┐ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рж╛
        display_columns = ['Meter Number', 'Issue Date', 'Status'] 
        
        if not filtered_df.empty:
            st.success(f"тЬЕ ржЖржкржирж╛рж░ ржЬржирзНржп ржмрж░рж╛ржжрзНржж **{len(filtered_df)} ржЯрж┐ ржорж┐ржЯрж╛рж░** ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗред")
            
            # ржбрзЗржЯрж╛ ржЯрзЗржмрж┐рж▓рзЗ ржкрзНрж░ржжрж░рзНрж╢ржи
            st.dataframe(filtered_df[display_columns], use_container_width=True)
            
            st.caption(f"рж╕рж░рзНржмрж╢рзЗрж╖ ржЖржкржбрзЗржЯ: {time.strftime('%H:%M:%S', time.localtime())} | ржПржЗ ржбрзЗржЯрж╛ ржкрзНрж░рждрж┐ рзл ржорж┐ржирж┐ржЯ ржЕржирзНрждрж░ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржЖржкржбрзЗржЯ рж╣ржмрзЗред")
        else:
            st.warning(f"тЪая╕П '{client_input}' ржирж╛ржорзЗ ржХрзЛржирзЛ ржорж┐ржЯрж╛рж░ ржмрж╛ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржирж╛ржорзЗрж░ ржмрж╛ржирж╛ржи ржЪрзЗржХ ржХрж░рзБржиред")
            
    else:
        st.info("ржЙржкрж░рзЗ ржЖржкржирж╛рж░ ржирж╛ржо рж▓рж┐ржЦрзЗ ржбрзЗржЯрж╛ ржжрзЗржЦрждрзЗ рж╢рзБрж░рзБ ржХрж░рзБржиред")

if __name__ == '__main__':
    main_app()