import streamlit as st
import pandas as pd
import gspread
import time

# --- рзз. ржЖржкржирж╛рж░ рж╕рзЗржЯрж┐ржВрж╕ ржжрж┐ржи (ржПржЦрж╛ржирзЗ ржХрзЛржирзЛ ржмрзНржпржХрзНрждрж┐ржЧржд ржХрзА рж░рж╛ржЦржмрзЗржи ржирж╛) ---
# ржПржЗ ржнрзНржпрж╛рж▓рзБржЧрзБрж▓рж┐ ржЖржкржирж╛рж░ ржХрзЛржбрзЗрж░ ржоржзрзНржпрзЗ ржерж╛ржХржмрзЗред
SHEET_NAME = "ржЖржкржирж╛рж░ Google Sheet-ржПрж░ ржЖрж╕рж▓ ржирж╛ржоржЯрж┐ ржжрж┐ржи"       # ржЖржкржирж╛рж░ Google Sheet-ржПрж░ рж╕ржарж┐ржХ ржирж╛ржо (ржпрзЗржоржи: Meter Project Database)
WORKSHEET_NAME = "Meter_Master_Data"                          # ржЖржкржирж╛рж░ ржбрзЗржЯрж╛ ржЯрзНржпрж╛ржмрзЗрж░ ржирж╛ржо (ржпрзЗржоржи: Sheet1 ржмрж╛ Master_Data)

# --- рзи. Google Sheets ржХрж╛ржирзЗржХрж╢ржи ржЗржирж┐рж╢рж┐ржпрж╝рж╛рж▓рж╛ржЗржЬрзЗрж╢ржи ---
# Streamlit Secrets (secrets.toml) ржерзЗржХрзЗ рж╕рзБрж░ржХрзНрж╖рж┐рждржнрж╛ржмрзЗ ржХрзА рж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
# 'gcp_service_account' ржирж╛ржоржЯрж┐ secrets.toml ржлрж╛ржЗрж▓рзЗ ржмрзНржпржмрж╣рзГржд ржирж╛ржорзЗрж░ рж╕рж╛ржерзЗ ржорж┐рж▓рждрзЗ рж╣ржмрзЗред
try:
    gc = gspread.service_account_from_dict(st.secrets["gcp_service_account"])
except Exception as e:
    # ржпржжрж┐ ржХрж╛ржирзЗржХрж╢ржи ржмрзНржпрж░рзНрже рж╣ржпрж╝, рждржмрзЗ ржПрж░рж░ ржорзЗрж╕рзЗржЬ ржжрзЗржЦрж┐ржпрж╝рзЗ ржЕрзНржпрж╛ржк ржерж╛ржорж┐ржпрж╝рзЗ ржжрзЗржУржпрж╝рж╛
    st.error(f"тЭМ ржХрж╛ржирзЗржХрж╢ржи ржПрж░рж░: Google Sheets ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрзА рж▓рзЛржб ржХрж░рж╛ ржпрж╛ржпрж╝ржирж┐ред Streamlit Secrets ржЪрзЗржХ ржХрж░рзБржиред {e}")
    st.stop()


# --- рзй. ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи (Caching рж╕рж╣) ---
# @st.cache_data ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ ржпрж╛рждрзЗ ржкрзНрж░рждрж┐ рзл ржорж┐ржирж┐ржЯ ржЕржирзНрждрж░ ржбрзЗржЯрж╛ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ рж░рж┐ржлрзНрж░рзЗрж╢ рж╣ржпрж╝ (ttl=300 рж╕рзЗржХрзЗржирзНржб)
@st.cache_data(ttl=300) 
def load_data_from_sheet():
    """Google Sheet ржерзЗржХрзЗ рж╕ржорж╕рзНржд ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рзЗред"""
    try:
        sh = gc.open(SHEET_NAME)
        worksheet = sh.worksheet(WORKSHEET_NAME)
        
        # рж╕ржорж╕рзНржд ржбрзЗржЯрж╛ pandas DataFrame-ржП рж▓рзЛржб ржХрж░рж╛
        data = worksheet.get_all_records()
        df = pd.DataFrame(data)
        
        # ржХрж▓рж╛ржорзЗрж░ ржирж╛ржорзЗрж░ рж╕рзНржкрзЗрж╕ ржорзБржЫрзЗ ржЫрзЛржЯ ржХрж░рж╛ (ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛рж░ ржЬржирзНржп)
        df.columns = [col.strip() for col in df.columns] 
        
        return df
    
    except gspread.exceptions.SpreadsheetNotFound:
        st.error(f"тЭМ ржбрзЗржЯрж╛ржмрзЗрж╕ ржПрж░рж░: рж╢рзАржЯ '{SHEET_NAME}' ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржирж╛ржорзЗрж░ ржмрж╛ржирж╛ржи ржЪрзЗржХ ржХрж░рзБржи ржПржмржВ рж╢рзАржЯржЯрж┐ рж╕рж╛рж░рзНржнрж┐рж╕ ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯрзЗрж░ рж╕рж╛ржерзЗ рж╢рзЗржпрж╝рж╛рж░ ржХрж░рж╛ ржЖржЫрзЗ ржХрж┐ржирж╛ ржжрзЗржЦрзБржиред")
        return pd.DataFrame()
    except Exception as e:
        st.error(f"тЭМ ржбрзЗржЯрж╛ рж▓рзЛржбрж┐ржВ ржПрж░рж░: {e}")
        return pd.DataFrame()

# --- рзк. Streamlit ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржорзВрж▓ ржХрж╛ржарж╛ржорзЛ ---
def main_app():
    st.set_page_config(page_title="ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржорж┐ржЯрж╛рж░ ржкрзЛрж░рзНржЯрж╛рж▓", layout="wide")
    st.title("ЁЯТб ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржорж┐ржЯрж╛рж░ ржЯрзНрж░рзНржпрж╛ржХрж┐ржВ ржкрзЛрж░рзНржЯрж╛рж▓")
    st.markdown("---")

    # ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
    df_master = load_data_from_sheet()

    if df_master.empty:
        st.info("тЪая╕П ржбрзЗржЯрж╛ржмрзЗрж╕рзЗ ржХрзЛржирзЛ ржбрзЗржЯрж╛ ржирзЗржЗ ржмрж╛ рж▓рзЛржбрж┐ржВ-ржП рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред")
        return

    # ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯрзЗрж░ ржирж╛ржо ржЗржиржкрзБржЯ ржирзЗржУржпрж╝рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржЯрзЗржХрзНрж╕ржЯ ржмржХрзНрж╕ рждрзИрж░рж┐ ржХрж░рж╛
    client_input = st.text_input(
        "ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржкржирж╛рж░ **ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯрзЗрж░ ржкрзБрж░рзЛ ржирж╛ржо** ржПржЦрж╛ржирзЗ рж▓рж┐ржЦрзБржи:",
        placeholder="ржпрзЗржоржи: Client A ржмрж╛ Ramesh Mondal"
    )

    if client_input:
        # ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯрзЗрж░ ржирж╛ржо ржЕржирзБржпрж╛ржпрж╝рзА ржбрзЗржЯрж╛ ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░рж╛
        # 'Client Name' ржХрж▓рж╛ржоржЯрж┐ ржЖржкржирж╛рж░ рж╢рзАржЯрзЗрж░ ржХрж▓рж╛ржорзЗрж░ ржирж╛ржорзЗрж░ рж╕рж╛ржерзЗ рж╣рзБржмрж╣рзБ ржорж┐рж▓рждрзЗ рж╣ржмрзЗ
        filtered_df = df_master[df_master['Client Name'].str.lower() == client_input.lower()]
        
        # ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯржжрзЗрж░ ржжрзЗржЦрж╛ржирзЛрж░ ржЬржирзНржп ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржХрж▓рж╛ржоржЧрзБрж▓рж┐ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рж╛
        # ржЖржкржирж┐ ржПржЗ рж▓рж┐рж╕рзНржЯ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржкрж╛рж░рзЗржи:
        display_columns = ['Meter Number', 'Issue Date', 'Status'] 
        
        if not filtered_df.empty:
            st.success(f"тЬЕ ржЖржкржирж╛рж░ ржЬржирзНржп ржмрж░рж╛ржжрзНржж **{len(filtered_df)} ржЯрж┐ ржорж┐ржЯрж╛рж░** ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗред")
            
            # ржбрзЗржЯрж╛ ржЯрзЗржмрж┐рж▓рзЗ ржкрзНрж░ржжрж░рзНрж╢ржи
            st.dataframe(filtered_df[display_columns], use_container_width=True)
            
            st.caption(f"рж╕рж░рзНржмрж╢рзЗрж╖ ржбрзЗржЯрж╛ рж░рж┐ржлрзНрж░рзЗрж╢: {time.strftime('%H:%M:%S', time.localtime())} | ржбрзЗржЯрж╛ ржкрзНрж░рждрж┐ рзл ржорж┐ржирж┐ржЯ ржЕржирзНрждрж░ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржЖржкржбрзЗржЯ рж╣ржпрж╝ред")
        else:
            st.warning(f"тЪая╕П '{client_input}' ржирж╛ржорзЗ ржХрзЛржирзЛ ржорж┐ржЯрж╛рж░ ржмрж╛ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржирж╛ржорзЗрж░ ржмрж╛ржирж╛ржи ржЪрзЗржХ ржХрж░рзБржиред")
            
    else:
        st.info("ржЙржкрж░рзЗ ржЖржкржирж╛рж░ ржирж╛ржо рж▓рж┐ржЦрзЗ ржбрзЗржЯрж╛ ржжрзЗржЦрждрзЗ рж╢рзБрж░рзБ ржХрж░рзБржиред")

if __name__ == '__main__':
    main_app()
